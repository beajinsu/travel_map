<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <script>
        L_NO_TOUCH = false;
        L_DISABLE_3D = false;
    </script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; }
        /* ì—°ë„ ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ */
        .year-controls {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 15px;
            font-family: Arial, sans-serif;
            height: 36px;
        }
        .btn {
            background: #007cba;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
            white-space: nowrap;
        }
        .btn:hover { background: #005a8b; }
        .btn.active { background: #28a745; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-all {
            padding: 6px 20px;
            min-width: 80px;
        }
        .year-slider { width: 200px; }
        .year-display { 
            font-weight: bold; 
            font-size: 16px; 
            color: #333; 
            min-width: 50px; 
            text-align: center; 
        }
        .year-range { 
            font-size: 11px; 
            color: #666; 
            display: flex; 
            justify-content: space-between; 
            width: 200px; 
            margin-top: 2px;
        }
        .slider-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        .year-display-center {
            position: absolute;
            top: 82%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-weight: bold;
            font-size: 14px;
            color: #333;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 12px;
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
            pointer-events: none;
            display: block;
        }
    </style>
    <!-- Leaflet core -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.css"/>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.6.0/dist/leaflet.js"></script>
    <!-- Heat plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style>#map { position: relative; width: 100%; height: 100%; }</style>
</head>
<body>
    <!-- ì—°ë„ ì»¨íŠ¸ë¡¤ -->
    <div class="year-controls">
        <button id="allYearsBtn" class="btn btn-all active">ì „ì²´ ë³´ê¸°</button>
        <button id="prevBtn" class="btn">â—€ï¸</button>
        <div class="slider-container">
            <div id="yearDisplayCenter" class="year-display-center"></div>
            <input type="range" id="yearSlider" class="year-slider" step="1">
            <div class="year-range"><span></span><span></span></div>
        </div>
        <button id="nextBtn" class="btn">â–¶ï¸</button>
        <div id="yearDisplay" class="year-display" style="display: none;"></div>
    </div>
    <div id="map"></div>

    <script>
        // 1) ì§€ë„ ì´ˆê¸°í™”
        var map = L.map("map", { center: [20, 0], zoom: 2, zoomControl: true });
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: 'Data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
        }).addTo(map);
    </script>

    <!-- ì—°ë„ë³„ íˆíŠ¸ë§µ ë°ì´í„° ë¡œë“œ -->
    <script src="scripts/heat_data.js"></script>
    <script>
        // ìƒ˜í”Œ ë°ì´í„° (ì‹¤ì œ ì‚¬ìš© ì‹œ scripts/heat_data.jsì—ì„œ ë¡œë“œ)
        if (typeof heatDataByYear === 'undefined') {
            var heatDataByYear = {
                "all": [
                    [37.5665, 126.9780], // ì„œìš¸
                    [35.6762, 139.6503], // ë„ì¿„
                    [40.7128, -74.0060], // ë‰´ìš•
                    [51.5074, -0.1278],  // ëŸ°ë˜
                    [48.8566, 2.3522],   // íŒŒë¦¬
                ],
                "2015": [[37.5665, 126.9780], [35.6762, 139.6503]],
                "2016": [[37.5665, 126.9780], [1.3521, 103.8198]],
                "2017": [[37.5665, 126.9780], [40.7128, -74.0060]],
                "2018": [[37.5665, 126.9780], [41.0082, 28.9784]],
                "2019": [[37.5665, 126.9780], [55.7558, 37.6173]],
                "2020": [[37.5665, 126.9780], [40.7128, -74.0060]],
                "2021": [[37.5665, 126.9780], [35.6762, 139.6503]],
                "2022": [[37.5665, 126.9780], [48.8566, 2.3522]],
                "2023": [[37.5665, 126.9780], [52.5200, 13.4050]],
                "2024": [[37.5665, 126.9780], [38.9072, -77.0369]]
            };
        }

        // ì „ì—­ ë³€ìˆ˜
        var currentHeatLayer = null;
        var currentYear = 'all';

        // UI ìš”ì†Œ
        const allBtn = document.getElementById('allYearsBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const slider = document.getElementById('yearSlider');
        const yearDisplay = document.getElementById('yearDisplay');
        const yearDisplayCenter = document.getElementById('yearDisplayCenter');
        const rangeLabels = document.querySelector('.year-range').children;

        // ê°€ìš© ì—°ë„ ëª©ë¡ (heatDataByYearëŠ” heat_data.jsì—ì„œ ì œê³µ)
        const years = Object.keys(heatDataByYear)
            .filter(y => y !== 'all' && !isNaN(parseInt(y)))
            .map(y => parseInt(y))
            .sort((a, b) => a - b);
        
        console.log('ì²˜ë¦¬ëœ ì—°ë„ ë°°ì—´:', years);
        
        const minY = years[0];
        const maxY = years[years.length - 1];

        // ìŠ¬ë¼ì´ë” ë° ë¼ë²¨ ì„¤ì •
        slider.min = minY; 
        slider.max = maxY; 
        slider.value = minY;
        slider.step = 1;
        rangeLabels[0].textContent = minY;
        rangeLabels[1].textContent = maxY;
        
        console.log('ìŠ¬ë¼ì´ë” ì„¤ì • ì™„ë£Œ:', {min: minY, max: maxY, value: slider.value});

        // íˆíŠ¸ë§µ ë Œë”ë§ í•¨ìˆ˜
        function showHeat(year) {
            console.log('showHeat í˜¸ì¶œë¨, ì—°ë„:', year);
            
            if (currentHeatLayer) {
                map.removeLayer(currentHeatLayer);
                currentHeatLayer = null;
            }
            
            var data = heatDataByYear[year] || [];
            console.log('ë°ì´í„° ê¸¸ì´:', data.length);
            
            if (data.length > 0) {
                currentHeatLayer = L.heatLayer(data, {
                    radius: 25, 
                    blur: 20, 
                    minOpacity: 0.3,
                    gradient: {0.2:'blue',0.4:'lime',0.6:'orange',0.8:'red'}
                }).addTo(map);
                updateHeatOptions();
            }
            
            currentYear = year;
            updateUI();
            console.log('currentYear ì—…ë°ì´íŠ¸ë¨:', currentYear);
        }

        // ì¤Œë³„ íˆíŠ¸ë§µ ì˜µì…˜ ì—…ë°ì´íŠ¸
        function updateHeatOptions() {
            if (!currentHeatLayer) return;
            var z = map.getZoom();
            var rad = [10,10,10,10,28,25,22,19,16,13,10,7,4,1,0,0,0,0,0][z]||0;
            var bl = [5,5,5,5,14,12,11,9,8,6,5,3,2,1,0,0,0,0,0][z]||0;
            currentHeatLayer.setOptions({ radius: rad, blur: bl });
        }

        // UI ìƒíƒœ ê°±ì‹ 
        function updateUI() {
            console.log('updateUI í˜¸ì¶œ, currentYear:', currentYear);
            
            allBtn.classList.toggle('active', currentYear === 'all');
            
            if (currentYear === 'all') {
                yearDisplay.style.display = 'none';
                yearDisplayCenter.style.display = 'block';
                yearDisplayCenter.textContent = 'ì „ì²´ë³´ê¸°';  // ì „ì²´ë³´ê¸° ëª¨ë“œì—ì„œ "ì „ì²´ë³´ê¸°" í‘œì‹œ
                prevBtn.disabled = false;  // ë²„íŠ¼ í™œì„±í™”
                nextBtn.disabled = false;  // ë²„íŠ¼ í™œì„±í™”
                slider.disabled = false;
                slider.style.opacity = '1';
                console.log('ì „ì²´ ë³´ê¸° ëª¨ë“œ - ëª¨ë“  ì»¨íŠ¸ë¡¤ í™œì„±í™”');
            } else {
                yearDisplay.style.display = 'none';  // ê¸°ì¡´ ìš°ì¸¡ í‘œì‹œ ìˆ¨ê¹€
                yearDisplayCenter.style.display = 'block';  // ì¤‘ì•™ í‘œì‹œ í™œì„±í™”
                yearDisplayCenter.textContent = currentYear;  // ì—°ë„ë³„ ëª¨ë“œì—ì„œ ì—°ë„ í‘œì‹œ
                
                var currentYearNum = parseInt(currentYear);
                var idx = years.indexOf(currentYearNum);
                
                console.log('ì—°ë„ë³„ ëª¨ë“œ - ìŠ¬ë¼ì´ë” í™œì„±í™”', {
                    í˜„ì¬ì—°ë„: currentYearNum,
                    ì¸ë±ìŠ¤: idx,
                    ì „ì²´ì—°ë„ìˆ˜: years.length
                });
                
                prevBtn.disabled = (idx <= 0);
                nextBtn.disabled = (idx >= years.length - 1);
                slider.disabled = false;
                slider.style.opacity = '1';
                slider.value = currentYearNum;
                
                console.log('ìŠ¬ë¼ì´ë” í™œì„±í™”ë¨, ê°’:', slider.value, 'ë¹„í™œì„±í™”:', slider.disabled);
            }
        }

        // ì´ë²¤íŠ¸ ë°”ì¸ë”©
        allBtn.onclick = () => { 
            console.log('ì „ì²´ ë³´ê¸° í´ë¦­ë¨');
            showHeat('all'); 
        };
        
        prevBtn.onclick = () => {
            console.log('ì´ì „ ë²„íŠ¼ í´ë¦­ë¨');
            // ì „ì²´ ë³´ê¸° ìƒíƒœë¼ë©´ ë§ˆì§€ë§‰ ì—°ë„ë¡œ ì‹œì‘
            if (currentYear === 'all') {
                showHeat(years[years.length - 1].toString());
            } else {
                var currentYearNum = parseInt(currentYear);
                var i = years.indexOf(currentYearNum);
                if (i > 0) {
                    var prevYear = years[i-1].toString();
                    console.log('ì´ì „ ë²„íŠ¼ í´ë¦­, ì´ë™í•  ì—°ë„:', prevYear);
                    showHeat(prevYear);
                }
            }
        };
        
        nextBtn.onclick = () => {
            console.log('ë‹¤ìŒ ë²„íŠ¼ í´ë¦­ë¨');
            // ì „ì²´ ë³´ê¸° ìƒíƒœë¼ë©´ ì²« ë²ˆì§¸ ì—°ë„ë¡œ ì‹œì‘
            if (currentYear === 'all') {
                showHeat(years[0].toString());
            } else {
                var currentYearNum = parseInt(currentYear);
                var i = years.indexOf(currentYearNum);
                if (i < years.length-1) {
                    var nextYear = years[i+1].toString();
                    console.log('ë‹¤ìŒ ë²„íŠ¼ í´ë¦­, ì´ë™í•  ì—°ë„:', nextYear);
                    showHeat(nextYear);
                }
            }
        };
        
        // ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ - ë‹¨ìˆœí™”í•˜ê³  ê°•í™”
        function handleSliderChange(e) {
            var sliderValue = parseInt(e.target.value);
            var selectedYear = sliderValue.toString();
            
            console.log('ìŠ¬ë¼ì´ë” ë³€ê²½ë¨:', {
                ìŠ¬ë¼ì´ë”ê°’: sliderValue,
                ì„ íƒì—°ë„: selectedYear,
                í˜„ì¬ì—°ë„: currentYear,
                ì‚¬ìš©ê°€ëŠ¥ì—°ë„: years,
                ë°ì´í„°í‚¤: Object.keys(heatDataByYear)
            });
            
            // ë°ì´í„°ì— í•´ë‹¹ ì—°ë„ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if (heatDataByYear[selectedYear]) {
                console.log('ìœ íš¨í•œ ì—°ë„, íˆíŠ¸ë§µ ì—…ë°ì´íŠ¸');
                showHeat(selectedYear);
            } else {
                console.log('ìœ íš¨í•˜ì§€ ì•Šì€ ì—°ë„, ì‚¬ìš© ê°€ëŠ¥í•œ í‚¤ë“¤:', Object.keys(heatDataByYear));
            }
        }
        
        // ë” ê°„ë‹¨í•œ ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
        slider.oninput = function(e) {
            console.log('oninput ì´ë²¤íŠ¸ ë°œìƒ, ê°’:', e.target.value);
            handleSliderChange(e);
        };
        
        slider.onchange = function(e) {
            console.log('onchange ì´ë²¤íŠ¸ ë°œìƒ, ê°’:', e.target.value);
            handleSliderChange(e);
        };
        
        // ì¶”ê°€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
        slider.addEventListener('input', function(e) {
            console.log('addEventListener input ì´ë²¤íŠ¸ ë°œìƒ, ê°’:', e.target.value);
            handleSliderChange(e);
        });
        
        slider.addEventListener('change', function(e) {
            console.log('addEventListener change ì´ë²¤íŠ¸ ë°œìƒ, ê°’:', e.target.value);
            handleSliderChange(e);
        });
        
        // ì§ì ‘ ë§ˆìš°ìŠ¤/í„°ì¹˜ ì´ë²¤íŠ¸ë„ ì²˜ë¦¬
        slider.addEventListener('mouseup', handleSliderChange);
        slider.addEventListener('touchend', handleSliderChange);
        
        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ë„ ì¶”ê°€
        slider.addEventListener('keyup', handleSliderChange);

        // ì¤Œ ì´ë²¤íŠ¸
        map.on('zoomend', updateHeatOptions);
        
        // ì´ˆê¸° í‘œì‹œë¥¼ ì „ì²´ ë³´ê¸°ë¡œ ë³€ê²½
        console.log('ì´ˆê¸°í™” ì‹œì‘');
        console.log('ì‚¬ìš© ê°€ëŠ¥í•œ ì—°ë„ë“¤:', years);
        console.log('ìŠ¬ë¼ì´ë” ì„¤ì •:', slider.min, slider.max, slider.value);
        console.log('heatDataByYear í‚¤ë“¤:', Object.keys(heatDataByYear));
        
        // ìŠ¬ë¼ì´ë” í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
        window.testSlider = function() {
            console.log('ìŠ¬ë¼ì´ë” í…ŒìŠ¤íŠ¸ ì‹œì‘');
            console.log('ìŠ¬ë¼ì´ë” í˜„ì¬ ê°’:', slider.value);
            console.log('ìŠ¬ë¼ì´ë” ë¹„í™œì„±í™” ì—¬ë¶€:', slider.disabled);
            
            // ìˆ˜ë™ìœ¼ë¡œ ì—°ë„ ë³€ê²½ í…ŒìŠ¤íŠ¸
            var testYear = '2020';
            if (heatDataByYear[testYear]) {
                console.log('2020ë…„ ë°ì´í„° ì¡´ì¬, í…ŒìŠ¤íŠ¸ ì‹¤í–‰');
                showHeat(testYear);
            } else {
                console.log('2020ë…„ ë°ì´í„° ì—†ìŒ');
            }
        };
        
        // ë””í´íŠ¸ëŠ” ì „ì²´ ë³´ê¸°
        showHeat('all');
    </script>

    <!-- ë§ˆì»¤ ë ˆì´ì–´ (ì¤Œ ë ˆë²¨ì— ë”°ë¼) -->
    <script src="scripts/markers.js"></script>
    <script>
        // ìƒ˜í”Œ ë§ˆì»¤ ë°ì´í„° (ì‹¤ì œ ì‚¬ìš© ì‹œ scripts/markers.jsì—ì„œ ë¡œë“œ)
        if (typeof markers === 'undefined') {
            var markers = [
                {lat: 37.5665, lng: 126.9780, popup: "ì„œìš¸ ğŸ‡°ğŸ‡·", tooltip: "Seoul", link: ""},
                {lat: 35.6762, lng: 139.6503, popup: "ë„ì¿„ ğŸ‡¯ğŸ‡µ", tooltip: "Tokyo", link: ""},
                {lat: 40.7128, lng: -74.0060, popup: "ë‰´ìš• ğŸ‡ºğŸ‡¸", tooltip: "New York", link: ""},
                {lat: 51.5074, lng: -0.1278, popup: "ëŸ°ë˜ ğŸ‡¬ğŸ‡§", tooltip: "London", link: ""},
                {lat: 48.8566, lng: 2.3522, popup: "íŒŒë¦¬ ğŸ‡«ğŸ‡·", tooltip: "Paris", link: ""}
            ];
        }

        var markerLayer = L.layerGroup();
        markers.forEach(m => {
            var mk = L.marker([m.lat, m.lng]);
            mk.bindPopup(m.link? `<a href="${m.link}" target="_blank">${m.popup}</a>` : m.popup, { maxWidth:250 });
            mk.bindTooltip(m.tooltip||m.popup, { sticky:true });
            markerLayer.addLayer(mk);
        });
        
        const SHOW_ZOOM = 6;
        function toggleMarkers() {
            if (map.getZoom() >= SHOW_ZOOM) {
                if (!map.hasLayer(markerLayer)) {
                    map.addLayer(markerLayer);
                }
            } else {
                if (map.hasLayer(markerLayer)) {
                    map.removeLayer(markerLayer);
                }
            }
        }
        
        map.on('zoomend', toggleMarkers);
        toggleMarkers();
    </script>
</body>
</html>